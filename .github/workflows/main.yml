name: Simulate Google Play Gift Card Purchase with Balance Check

on:
  workflow_dispatch:  # Manual trigger

jobs:
  buy-google-play-code:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Check sufficient balance
      run: |
        BALANCE=0.50
        AMOUNT=10
        echo "Current balance: $BALANCE"
        echo "Purchase amount: $AMOUNT"
        if (( $(echo "$BALANCE < $AMOUNT" | bc -l) )); then
          echo "Insufficient balance to purchase Google Play redeem code."
          exit 1
        else
          echo "Sufficient balance to proceed."
        fi

    - name: Simulate payment verification
      if: success()
      run: |
        echo "Payment of $AMOUNT verified successfully."

    - name: Simulate generating 16-digit Google Play redeem code
      if: success()
      id: generate_code
      run: |
        CODE=$(head /dev/urandom | tr -dc A-Z0-9 | head -c16)
        echo "Redeem code: $CODE"
        echo "::set-output name=redeem_code::$CODE"

    - name: Simulate redeem code redemption delay (40 seconds)
      if: success()
      run: |
        echo "Redeeming code in 40 seconds..."
        sleep 40
        echo "Redeem code redeemed successfully."

    - name: Simulate waiting 10 minutes to buy redeem code
      if: success()
      run: |
        echo "Waiting 10 minutes before next purchase..."
        sleep 600

    - name: Final message
      if: success()
      run: |
        echo "Google Play redeem code ${{ steps.generate_code.outputs.redeem_code }} generated and redeemed successfully."
